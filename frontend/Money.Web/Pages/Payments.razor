@page "/payments"
@attribute [Authorize]

<PageTitle>Операции</PageTitle>

@if (_init == false)
{
    <MudStack AlignItems="AlignItems.Center" Row>
        <MudProgressCircular Indeterminate />
        <MudText Typo="Typo.body1">Загрузка..</MudText>
    </MudStack>

    return;
}

<MudTabs Elevation="4" Outlined>
    <MudTabPanel ID="1" Text="Список операций">
        <MudStack Class="mt-3" Spacing="2">
            @foreach (PaymentsDay paymentsDay in PaymentsDays)
            {
                <MudCard Elevation="3">
                    <MudCardHeader Class="border-b-4 border-solid mud-border-tertiary" Style="padding: 8px 8px;">
                        <MudItem md="2" xs="3">
                            <MudStack Justify="Justify.FlexStart" Row StretchItems="StretchItems.End">
                                <MudIcon Icon="@Icons.Material.Rounded.CalendarToday" Size="Size.Small" />
                                <MudText>
                                    @paymentsDay.Date.ToShortDateString()
                                </MudText>
                            </MudStack>
                        </MudItem>

                        <MudItem md="2" xs="3">
                            <MudStack AlignItems="AlignItems.Center" Row>
                                <MudIconButton Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Rounded.Add" Title="Добавить расходы" />
                                <MudIconButton Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Rounded.Add" Title="Добавить доходы" />
                                <MudIconButton Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Rounded.Add" Title="Быстрое добавление" />
                            </MudStack>
                        </MudItem>

                        @foreach (PaymentTypes.Value paymentType in PaymentTypes.Values)
                        {
                            <MudItem md="2" xs="3">
                                <MudStack AlignItems="AlignItems.Center" Justify="Justify.FlexEnd" Row StretchItems="StretchItems.End">
                                    <MudIcon Color="@paymentType.Color" Icon="@paymentType.Icon" Size="Size.Small" />
                                    <MudText>
                                        @paymentsDay.Payments.Where(x => x.IsDeleted == false && x.Category.PaymentTypeId == paymentType.Id).Sum(x => x.Sum).ToString("N2")
                                    </MudText>
                                </MudStack>
                            </MudItem>
                        }
                        <MudSpacer />
                    </MudCardHeader>
                    <MudCardContent Style="padding: 8px 8px;">
                        <MudStack Spacing="0">
                            @foreach (Payment payment in paymentsDay.Payments)
                            {
                                if (payment.IsDeleted)
                                {
                                    <MudStack AlignItems="AlignItems.Center" Row>
                                        <MudText Style="text-decoration: line-through;">
                                            @payment.Sum.ToString("N2") - @payment.Category.Name - @payment.Comment
                                        </MudText>
                                        <MudSpacer />
                                        <MudButton Color="Color.Info"
                                                   EndIcon="@Icons.Material.Sharp.Cancel"
                                                   OnClick="() => Restore(payment)"
                                                   Size="Size.Large">
                                            Восстановить
                                        </MudButton>
                                    </MudStack>
                                }
                                else
                                {
                                    <MudStack AlignItems="AlignItems.Center" Row>
                                        <MudIcon Color="@payment.Category.PaymentType.Color" Icon="@payment.Category.PaymentType.Icon" Size="Size.Small" />
                                        <MudIconButton Icon="@Icons.Material.Rounded.ModeEdit" OnClick="() => Update(payment)" Size="Size.Small" Title="Редактировать" />
                                        <MudItem xs="2">
                                            <MudText Align="Align.Left" Inline>@payment.Sum.ToString("N2")</MudText>
                                        </MudItem>
                                        <MudItem xs="3">
                                            <MudText Align="Align.Left" Inline title="@payment.Category.Name">@payment.Category.Name</MudText>
                                        </MudItem>
                                        <MudItem xs="3">
                                            <MudText Align="Align.Left" Inline title="@payment.Place">@payment.Place</MudText>
                                        </MudItem>
                                        @if (payment.CreatedTaskId != null)
                                        {
                                            <MudItem xs="1">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Title="Создано регулярной задачей" />
                                            </MudItem>
                                        }
                                        <MudItem xs="4">
                                            <MudText Align="Align.Left" Inline Typo="Typo.body2">@payment.Comment</MudText>
                                        </MudItem>
                                        <MudSpacer />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => Delete(payment)" Size="Size.Small" Title="Удалить" />
                                    </MudStack>
                                }

                                <MudDivider DividerType="DividerType.FullWidth" />
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    </MudTabPanel>
    <MudTabPanel Text="Регулярные операции" ID="2">
        =)
    </MudTabPanel>
    <MudTabPanel Text="Быстрые операции" ID="3">
        =)
    </MudTabPanel>
</MudTabs>
